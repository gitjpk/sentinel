{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Combined Sentinel Costs - Ingestion and Retention and Discounts",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/60f0fad6-2655-4552-ae41-ba05ebfe561c/resourcegroups/rg-sentinel/providers/microsoft.operationalinsights/workspaces/sentinel-msdemo",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"ccd5adcd-8d59-4cfe-99ec-98075de2e253\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DefaultSubscription_Internal\",\"type\":1,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| take 1\\r\\n| project subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"1ca69445-60fc-4806-b43d-ac7e6aad630a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"query\":\"summarize by subscriptionId\\r\\n| project value = strcat(\\\"/subscriptions/\\\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)\\r\\n\",\"crossComponentResources\":[\"value::selected\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"DefaultWorkspace_Internal\",\"type\":1,\"query\":\"resources | \\r\\nwhere type =~ 'Microsoft.operationsmanagement/solutions' | \\r\\nwhere name contains 'SecurityInsights' | \\r\\ntake 1 |\\r\\nproject id\\r\\n\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"051ec4a5-5d96-44f5-b5fa-a87a733301f5\"},{\"id\":\"67c2ce6e-ea54-4ae4-8343-3fcad8e53d1b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"label\":\"WorkspaceResourceID\",\"type\":5,\"isRequired\":true,\"query\":\"resources | \\r\\nwhere type =~ 'Microsoft.operationsmanagement/solutions' | \\r\\nwhere name contains 'SecurityInsights' | \\r\\nproject id = tostring(properties.workspaceResourceId), selected = iff(id =~ '{DefaultWorkspace_Internal}', true, false)\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"ba423df4-f83c-495f-8d57-b3b828f8f11c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"WorkspaceName\",\"type\":1,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| where id =~ \\\"{Workspace}\\\"\\r\\n| project name\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"eafaa0ec-7c3a-4ee5-babe-9850080c909d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"resourceGroup\",\"type\":1,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| where id =~ \\\"{Workspace}\\\"\\r\\n| project resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"9d001d6f-301c-4d03-b02c-b8cc6dce210b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"9375c625-e916-4f48-b072-352d6aeefddb\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IngestPrice\",\"label\":\"Ingestion price\",\"type\":1,\"description\":\"Enter your ingestion price per GB (Default: 5.22)\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{\\\\\\\"value\\\\\\\": 5.22}\\\",\\\"transformers\\\":null}\",\"queryType\":8},{\"id\":\"9d5299d0-36a0-4666-9803-ca6931bdaab7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RetentionPrice\",\"label\":\"Retention price\",\"type\":1,\"description\":\"Enter the retention price per GB/month that will be used in this workbook's calculations (Default: 0.12)\",\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{\\\\\\\"value\\\\\\\":\\\\\\\"0.12\\\\\\\"}\\\",\\\"transformers\\\":null}\",\"queryType\":8},{\"id\":\"1a6910ac-3478-460d-b8bd-f0801eb1f9ef\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ArchivePrice\",\"label\":\"Archive price\",\"type\":1,\"description\":\"Enter the archive price per GB/month that will be used in this workbook's calculations (Default: 0.0025)\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{\\\\\\\"value\\\\\\\": 0.025}\\\",\\\"transformers\\\":null}\",\"queryType\":8},{\"id\":\"67494f3e-322e-4411-9b45-1cbea03ed618\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TotalE5Seats\",\"label\":\"Total seats (E5/A5/F5/G5)\",\"type\":1,\"description\":\"Enter the total number of Microsoft 365 E5, A5, F5, G5 and Microsoft 365 E5, A5, F5, G5 Security licenses in your environment\",\"value\":\"10000\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"{Subscription}/resourcegroups/{resourceGroup}/providers/microsoft.operationalinsights/workspaces/{WorkspaceName}/tables?api-version=2022-10-01\\\",\\\"urlParams\\\":[],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.name\\\",\\\"columnid\\\":\\\"TableName\\\"},{\\\"path\\\":\\\"$.properties.schema.tableType\\\",\\\"columnid\\\":\\\"TableType\\\"},{\\\"path\\\":\\\"$.properties.plan\\\",\\\"columnid\\\":\\\"TablePlan\\\"},{\\\"path\\\":\\\"$.properties.retentionInDays\\\",\\\"columnid\\\":\\\"TableInteractivePeriod\\\"},{\\\"path\\\":\\\"$.properties.archiveRetentionInDays\\\",\\\"columnid\\\":\\\"TableArchivePeriod\\\"},{\\\"path\\\":\\\"$.properties.totalRetentionInDays\\\",\\\"columnid\\\":\\\"TotalRetentionPeriod\\\"},{\\\"path\\\":\\\"$.properties.lastPlanModifiedDate\\\",\\\"columnid\\\":\\\"lastPlanModifiedDate\\\",\\\"columnType\\\":\\\"datetime\\\"}]}}]}\",\"size\":4,\"title\":\"Retention settings for All Tables\",\"showRefreshButton\":true,\"queryType\":12,\"visualization\":\"table\",\"gridSettings\":{\"rowLimit\":10000,\"sortBy\":[{\"itemKey\":\"TableInteractivePeriod\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"TableInteractivePeriod\",\"sortOrder\":1}],\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"TablePlan\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TableInteractivePeriod\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Workspace\",\"comparison\":\"isEqualTo\",\"value\":\"Never\"},\"name\":\"TableRetentionQuery\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let EventsByIngestDate = Usage\\r\\n| summarize DailyIngestionMB = toreal(sum(Quantity)) by ingest_date = format_datetime(TimeGenerated, 'yyyy-MM-dd'), DataType, IsBillable, IsE5Discounted = iif(IsBillable and DataType in (\\\"SigninLogs\\\", \\r\\n\\\"AuditLogs\\\", \\r\\n\\\"AADNonInteractiveUserSignInLogs\\\", \\r\\n\\\"AADServicePrincipalSignInLogs\\\",\\r\\n\\\"AADManagedIdentitySignInLogs\\\",\\r\\n\\\"AADProvisioningLogs\\\",\\r\\n\\\"ADFSSignInLogs\\\",\\r\\n\\\"McasShadowItReporting\\\", \\r\\n\\\"InformationProtectionLogs_CL\\\", \\r\\n\\\"DeviceEvents\\\",  \\r\\n\\\"DeviceFileEvents\\\",  \\r\\n\\\"DeviceImageLoadEvents\\\",  \\r\\n\\\"DeviceInfo\\\",  \\r\\n\\\"DeviceLogonEvents\\\",  \\r\\n\\\"DeviceNetworkEvents\\\",  \\r\\n\\\"DeviceNetworkInfo\\\",  \\r\\n\\\"DeviceProcessEvents\\\",  \\r\\n\\\"DeviceRegistryEvents\\\",\\r\\n\\\"DeviceFileCertificateInfo\\\",  \\r\\n\\\"EmailAttachmentInfo\\\",  \\r\\n\\\"EmailEvents\\\",  \\r\\n\\\"EmailPostDeliveryEvents\\\",  \\r\\n\\\"EmailUrlInfo\\\",\\r\\n\\\"IdentityLogonEvents\\\",\\r\\n\\\"IdentityQueryEvents\\\",\\r\\n\\\"IdentityDirectoryEvents\\\",\\r\\n\\\"AlertEvidence\\\",\\r\\n\\\"CloudAppEvents\\\"), 1,0);\\r\\n EventsByIngestDate | project ingest_date, DataType, IsBillable, DailyIngestionMB, IsE5Discounted\\r\\n | join kind=inner (\\r\\n    EventsByIngestDate\\r\\n    | summarize DailyIngestionMB = toreal(sum(DailyIngestionMB))\\r\\n    by ingest_date, IsBillable, IsE5Discounted\\r\\n    | extend PercentDiscount = min_of(IsE5Discounted * (5*toreal({TotalE5Seats})), DailyIngestionMB)/DailyIngestionMB | project ingest_date, PercentDiscount, IsE5Discounted\\r\\n) on $left.ingest_date == $right.ingest_date and $left.IsE5Discounted == $right.IsE5Discounted\\r\\n| project ingest_date, DataType, IsBillable, DailyIngestionMB, PercentDiscount\\r\\n| extend FullIngestPrice= 0.001 * {IngestPrice} * DailyIngestionMB | extend DiscountedIngestPrice = FullIngestPrice * (1-PercentDiscount) * iif(IsBillable, 1, 0)\\r\\n| project ingest_date, DataType, IsBillable, DailyIngestionMB, PercentDiscount, FullIngestPrice, DiscountedIngestPrice\\r\\n| summarize TotalIngestionMB = toreal(sum(DailyIngestionMB)), AvgPercentDiscount = toreal(avg(PercentDiscount)), TotalDiscountedIngestPrice = toreal(sum(DiscountedIngestPrice)) by DataType, IsBillable\\r\\n| sort by IsBillable desc, TotalDiscountedIngestPrice, TotalIngestionMB\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Workspace\",\"comparison\":\"isEqualTo\",\"value\":\"Never\"},\"name\":\"TotalIngestPrice\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let EventsByIngestDate = Usage\\r\\n| summarize DailyIngestionMB = toreal(sum(Quantity)) by ingest_date = format_datetime(TimeGenerated, 'yyyy-MM-dd'), DataType, IsBillable, IsE5Discounted = iif(IsBillable and DataType in (\\\"SigninLogs\\\", \\r\\n\\\"AuditLogs\\\", \\r\\n\\\"AADNonInteractiveUserSignInLogs\\\", \\r\\n\\\"AADServicePrincipalSignInLogs\\\",\\r\\n\\\"AADManagedIdentitySignInLogs\\\",\\r\\n\\\"AADProvisioningLogs\\\",\\r\\n\\\"ADFSSignInLogs\\\",\\r\\n\\\"McasShadowItReporting\\\", \\r\\n\\\"InformationProtectionLogs_CL\\\", \\r\\n\\\"DeviceEvents\\\",  \\r\\n\\\"DeviceFileEvents\\\",  \\r\\n\\\"DeviceImageLoadEvents\\\",  \\r\\n\\\"DeviceInfo\\\",  \\r\\n\\\"DeviceLogonEvents\\\",  \\r\\n\\\"DeviceNetworkEvents\\\",  \\r\\n\\\"DeviceNetworkInfo\\\",  \\r\\n\\\"DeviceProcessEvents\\\",  \\r\\n\\\"DeviceRegistryEvents\\\",\\r\\n\\\"DeviceFileCertificateInfo\\\",  \\r\\n\\\"EmailAttachmentInfo\\\",  \\r\\n\\\"EmailEvents\\\",  \\r\\n\\\"EmailPostDeliveryEvents\\\",  \\r\\n\\\"EmailUrlInfo\\\",\\r\\n\\\"IdentityLogonEvents\\\",\\r\\n\\\"IdentityQueryEvents\\\",\\r\\n\\\"IdentityDirectoryEvents\\\",\\r\\n\\\"AlertEvidence\\\",\\r\\n\\\"CloudAppEvents\\\"), 1,0);\\r\\n EventsByIngestDate | project ingest_date, DataType, IsBillable, DailyIngestionMB, IsE5Discounted\\r\\n | join kind=inner (\\r\\n    EventsByIngestDate\\r\\n    | summarize DailyIngestionMB = toreal(sum(DailyIngestionMB))\\r\\n    by ingest_date, IsBillable, IsE5Discounted\\r\\n    | extend PercentDiscount = min_of(IsE5Discounted * (5*toreal({TotalE5Seats})), DailyIngestionMB)/DailyIngestionMB | project ingest_date, PercentDiscount, IsE5Discounted\\r\\n) on $left.ingest_date == $right.ingest_date and $left.IsE5Discounted == $right.IsE5Discounted\\r\\n| project ingest_date, DataType, IsBillable, DailyIngestionMB, PercentDiscount\\r\\n| extend FullIngestPrice= 0.001 * {IngestPrice} * DailyIngestionMB | extend DiscountedIngestPrice = FullIngestPrice * (1-PercentDiscount) * iif(IsBillable, 1, 0)\\r\\n| project ingest_date, DataType, IsBillable, DailyIngestionMB, PercentDiscount, FullIngestPrice, DiscountedIngestPrice\\r\\n| summarize TotalDiscountedIngestCost = toreal(sum(DiscountedIngestPrice)), TotalMBIngested = toreal(sum(DailyIngestionMB))\",\"size\":4,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalDiscountedIngestCost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}}},{\"columnMatch\":\"TotalMBIngested\",\"formatter\":0,\"numberFormat\":{\"unit\":4,\"options\":{\"style\":\"decimal\"}}}],\"sortBy\":[{\"itemKey\":\"$gen_number_TotalDiscountedIngestCost_0\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"TotalDiscountedIngestCost\",\"label\":\"Total Discounted Ingestion Cost\"},{\"columnId\":\"TotalMBIngested\",\"label\":\"Total MB Ingested\"}]},\"sortBy\":[{\"itemKey\":\"$gen_number_TotalDiscountedIngestCost_0\",\"sortOrder\":1}]},\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\",\\\"mergeType\\\":\\\"leftouter\\\",\\\"leftTable\\\":\\\"TotalIngestPrice\\\",\\\"rightTable\\\":\\\"TableRetentionQuery\\\",\\\"leftColumn\\\":\\\"DataType\\\",\\\"rightColumn\\\":\\\"TableName\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[TotalIngestPrice].DataType\\\",\\\"mergedName\\\":\\\"DataType\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].IsBillable\\\",\\\"mergedName\\\":\\\"IsBillable\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].TotalIngestionMB\\\",\\\"mergedName\\\":\\\"TotalIngestionMB\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].AvgPercentDiscount\\\",\\\"mergedName\\\":\\\"AvgPercentDiscount\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].TotalDiscountedIngestPrice\\\",\\\"mergedName\\\":\\\"TotalDiscountedIngestPrice\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[TableRetentionQuery].TableInteractivePeriod\\\",\\\"mergedName\\\":\\\"TableInteractivePeriod\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[TableRetentionQuery].TableArchivePeriod\\\",\\\"mergedName\\\":\\\"TableArchivePeriod\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[TableRetentionQuery].TotalRetentionPeriod\\\",\\\"mergedName\\\":\\\"TotalRetentionPeriod\\\",\\\"fromId\\\":\\\"0941f6fc-e018-4955-a3b3-5945b242c3d9\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"TotalEstimatedRetentionCost\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"([\\\\\\\"TotalIngestionMB\\\\\\\"]*(max([\\\\\\\"TableInteractivePeriod\\\\\\\"],90) -90) * {RetentionPrice} * 0.000033333) + ({ArchivePrice} * 0.000033333 * [\\\\\\\"TableArchivePeriod\\\\\\\"])\\\"}}]},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"TotalEstimatedCombinedCost\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"[\\\\\\\"TotalEstimatedRetentionCost\\\\\\\"] + [\\\\\\\"TotalDiscountedIngestPrice\\\\\\\"]\\\"}}]},{\\\"originalName\\\":\\\"[TableRetentionQuery].TablePlan\\\"},{\\\"originalName\\\":\\\"[TableRetentionQuery].TableType\\\"},{\\\"originalName\\\":\\\"[TableRetentionQuery].TableName\\\"},{\\\"originalName\\\":\\\"[TableRetentionQuery].lastPlanModifiedDate\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].RetentionPrice1\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].ArchivePrice1\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].RetentionPrice\\\"},{\\\"originalName\\\":\\\"[TotalIngestPrice].ArchivePrice\\\"}]}\",\"size\":0,\"title\":\"Total Cost Over Time Range\",\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalIngestionMB\",\"formatter\":0,\"numberFormat\":{\"unit\":4,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}},{\"columnMatch\":\"AvgPercentDiscount\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"percent\",\"maximumFractionDigits\":2}},\"tooltipFormat\":{\"tooltip\":\"Discount is based on eligable tables and E5 license count\"}},{\"columnMatch\":\"TotalDiscountedIngestPrice\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}},\"tooltipFormat\":{\"tooltip\":\"Cost for data ingestion based on price and total MB and including discount\"}},{\"columnMatch\":\"TableInteractivePeriod\",\"formatter\":0,\"numberFormat\":{\"unit\":27,\"options\":{\"style\":\"decimal\"}},\"tooltipFormat\":{\"tooltip\":\"Number of days that data is retained in a normal/searchable mode. This excludes the archive period\"}},{\"columnMatch\":\"TableArchivePeriod\",\"formatter\":0,\"numberFormat\":{\"unit\":27,\"options\":{\"style\":\"decimal\"}},\"tooltipFormat\":{\"tooltip\":\"Number of days to retain data in an \\\"archive\\\" state. Data is moved to archive after interactive period expires.\"}},{\"columnMatch\":\"TotalRetentionPeriod\",\"formatter\":0,\"numberFormat\":{\"unit\":27,\"options\":{\"style\":\"decimal\"}},\"tooltipFormat\":{\"tooltip\":\"Number of days calculated by adding Interactive Period + Archive Period\"}},{\"columnMatch\":\"TotalEstimatedRetentionCost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}},\"tooltipFormat\":{\"tooltip\":\"Estimated cost calculated by adding the Interactive Period Cost (first 90 days are free), plus the Archive Period Cost\"}},{\"columnMatch\":\"TotalEstimatedCombinedCost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"currency\":\"USD\",\"style\":\"currency\"}},\"tooltipFormat\":{\"tooltip\":\"Estimated cost calculated by adding Ingestion Cost, plus the Retention Cost\"}}],\"sortBy\":[{\"itemKey\":\"$gen_number_TableInteractivePeriod_5\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"DataType\",\"label\":\"Log Table Name\"},{\"columnId\":\"IsBillable\",\"label\":\"Is Billable?\"},{\"columnId\":\"TotalIngestionMB\",\"label\":\"Total Ingestion MB\"},{\"columnId\":\"AvgPercentDiscount\",\"label\":\"Avg Percent Discount\",\"comment\":\"Discount is based on eligable tables and E5 license count\"},{\"columnId\":\"TotalDiscountedIngestPrice\",\"label\":\"Ingestion Cost\",\"comment\":\"Cost for data ingestion based on price and total MB and including discount\"},{\"columnId\":\"TableInteractivePeriod\",\"label\":\"Interactive Period\",\"comment\":\"Number of days that data is retained in a normal/searchable mode. This excludes the archive period\"},{\"columnId\":\"TableArchivePeriod\",\"label\":\"Archive Period\",\"comment\":\"Number of days to retain data in an \\\"archive\\\" state. Data is moved to archive after interactive period expires.\"},{\"columnId\":\"TotalRetentionPeriod\",\"label\":\"Total Retention Period\",\"comment\":\"Number of days calculated by adding Interactive Period + Archive Period\"},{\"columnId\":\"TotalEstimatedRetentionCost\",\"label\":\"Total Estimated Retention Cost\",\"comment\":\"Estimated cost calculated by adding the Interactive Period Cost (first 90 days are free), plus the Archive Period Cost\"},{\"columnId\":\"TotalEstimatedCombinedCost\",\"label\":\"Total Estimated Combined Cost\",\"comment\":\"Estimated cost calculated by adding Ingestion Cost, plus the Retention Cost\"}]},\"sortBy\":[{\"itemKey\":\"$gen_number_TableInteractivePeriod_5\",\"sortOrder\":2}]},\"name\":\"FullDetail1\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let DistinctDates = Usage | distinct ingest_date = format_datetime(TimeGenerated, 'yyyy-MM-dd');\\r\\nlet DistinctDataTypes = Usage | distinct DataType, IsBillable, IsE5Discounted = iif(IsBillable and DataType in (\\\"SigninLogs\\\", \\r\\n\\\"AuditLogs\\\", \\r\\n\\\"AADNonInteractiveUserSignInLogs\\\", \\r\\n\\\"AADServicePrincipalSignInLogs\\\",\\r\\n\\\"AADManagedIdentitySignInLogs\\\",\\r\\n\\\"AADProvisioningLogs\\\",\\r\\n\\\"ADFSSignInLogs\\\",\\r\\n\\\"McasShadowItReporting\\\", \\r\\n\\\"InformationProtectionLogs_CL\\\", \\r\\n\\\"DeviceEvents\\\",  \\r\\n\\\"DeviceFileEvents\\\",  \\r\\n\\\"DeviceImageLoadEvents\\\",  \\r\\n\\\"DeviceInfo\\\",  \\r\\n\\\"DeviceLogonEvents\\\",  \\r\\n\\\"DeviceNetworkEvents\\\",  \\r\\n\\\"DeviceNetworkInfo\\\",  \\r\\n\\\"DeviceProcessEvents\\\",  \\r\\n\\\"DeviceRegistryEvents\\\",\\r\\n\\\"DeviceFileCertificateInfo\\\",  \\r\\n\\\"EmailAttachmentInfo\\\",  \\r\\n\\\"EmailEvents\\\",  \\r\\n\\\"EmailPostDeliveryEvents\\\",  \\r\\n\\\"EmailUrlInfo\\\",\\r\\n\\\"IdentityLogonEvents\\\",\\r\\n\\\"IdentityQueryEvents\\\",\\r\\n\\\"IdentityDirectoryEvents\\\",\\r\\n\\\"AlertEvidence\\\",\\r\\n\\\"CloudAppEvents\\\"), 1,0);\\r\\n//DistinctDataTypes | join kind=fullouter DistinctDates\\r\\nlet DistinctDateDataTypes = DistinctDates | extend dummy=1 | join kind=inner (DistinctDataTypes | extend dummy=1) on dummy | project ingest_date, DataType, IsBillable, IsE5Discounted;\\r\\n\\r\\nlet EventsByIngestDate = DistinctDateDataTypes | join kind=leftouter (\\r\\nUsage | distinct ingest_date = format_datetime(TimeGenerated, 'yyyy-MM-dd'), DataType, Quantity\\r\\n) on $left.ingest_date == $right.ingest_date and $left.DataType == $right.DataType | project ingest_date, DataType, Quantity, IsBillable, IsE5Discounted;\\r\\n\\r\\nEventsByIngestDate | summarize DailyIngestionMB = toreal(sum(Quantity)) by ingest_date, DataType, IsBillable, IsE5Discounted\\r\\n| extend PercentDiscount = iif(DailyIngestionMB > 0,min_of(IsE5Discounted * (5*toreal({TotalE5Seats})), DailyIngestionMB)/DailyIngestionMB, 0.0)\\r\\n| extend FullIngestPrice= 0.001 * {IngestPrice} * DailyIngestionMB \\r\\n| extend DiscountedIngestPrice = FullIngestPrice * (1-PercentDiscount) * iif(IsBillable, 1, 0)\\r\\n| project ingest_date, DataType, DiscountedIngestPrice\\r\\n| extend \\r\\n    obj_bag = bag_pack(DataType, DiscountedIngestPrice)\\r\\n    | summarize\\r\\n    obj_json = make_bag(obj_bag)\\r\\n    by ingest_date\\r\\n    | evaluate bag_unpack(obj_json)\\r\\n    | order by ingest_date asc\",\"size\":0,\"title\":\"Daily Detailed Ingestion Cost (Excludes Retention)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"xAxis\":\"ingest_date\",\"group\":null,\"createOtherGroup\":0}},\"name\":\"query - 26\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let DistinctDates = Usage | distinct ingest_date = format_datetime(TimeGenerated, 'yyyy-MM-dd');\\r\\nlet DistinctDataTypes = Usage | distinct DataType, IsBillable, IsE5Discounted = iif(IsBillable and DataType in (\\\"SigninLogs\\\", \\r\\n\\\"AuditLogs\\\", \\r\\n\\\"AADNonInteractiveUserSignInLogs\\\", \\r\\n\\\"AADServicePrincipalSignInLogs\\\",\\r\\n\\\"AADManagedIdentitySignInLogs\\\",\\r\\n\\\"AADProvisioningLogs\\\",\\r\\n\\\"ADFSSignInLogs\\\",\\r\\n\\\"McasShadowItReporting\\\", \\r\\n\\\"InformationProtectionLogs_CL\\\", \\r\\n\\\"DeviceEvents\\\",  \\r\\n\\\"DeviceFileEvents\\\",  \\r\\n\\\"DeviceImageLoadEvents\\\",  \\r\\n\\\"DeviceInfo\\\",  \\r\\n\\\"DeviceLogonEvents\\\",  \\r\\n\\\"DeviceNetworkEvents\\\",  \\r\\n\\\"DeviceNetworkInfo\\\",  \\r\\n\\\"DeviceProcessEvents\\\",  \\r\\n\\\"DeviceRegistryEvents\\\",\\r\\n\\\"DeviceFileCertificateInfo\\\",  \\r\\n\\\"EmailAttachmentInfo\\\",  \\r\\n\\\"EmailEvents\\\",  \\r\\n\\\"EmailPostDeliveryEvents\\\",  \\r\\n\\\"EmailUrlInfo\\\",\\r\\n\\\"IdentityLogonEvents\\\",\\r\\n\\\"IdentityQueryEvents\\\",\\r\\n\\\"IdentityDirectoryEvents\\\",\\r\\n\\\"AlertEvidence\\\",\\r\\n\\\"CloudAppEvents\\\"), 1,0);\\r\\n//DistinctDataTypes | join kind=fullouter DistinctDates\\r\\nlet DistinctDateDataTypes = DistinctDates | extend dummy=1 | join kind=inner (DistinctDataTypes | extend dummy=1) on dummy | project ingest_date, DataType, IsBillable, IsE5Discounted;\\r\\n\\r\\nlet EventsByIngestDate = DistinctDateDataTypes | join kind=leftouter (\\r\\nUsage | distinct ingest_date = format_datetime(TimeGenerated, 'yyyy-MM-dd'), DataType, Quantity\\r\\n) on $left.ingest_date == $right.ingest_date and $left.DataType == $right.DataType | project ingest_date, DataType, Quantity, IsBillable, IsE5Discounted;\\r\\n\\r\\nEventsByIngestDate | summarize DailyIngestionMB = toreal(sum(Quantity)) by ingest_date, DataType, IsBillable, IsE5Discounted\\r\\n| extend PercentDiscount = iif(DailyIngestionMB > 0,min_of(IsE5Discounted * (5*toreal({TotalE5Seats})), DailyIngestionMB)/DailyIngestionMB, 0.0)\\r\\n| extend FullIngestPrice= 0.001 * {IngestPrice} * DailyIngestionMB \\r\\n| extend DiscountedIngestPrice = FullIngestPrice * (1-PercentDiscount) * iif(IsBillable, 1, 0)\\r\\n| project ingest_date, DataType, DiscountedIngestPrice\\r\\n| extend \\r\\n    obj_bag = bag_pack(DataType, DiscountedIngestPrice)\\r\\n    | summarize\\r\\n    obj_json = make_bag(obj_bag)\\r\\n    by ingest_date\\r\\n    | evaluate bag_unpack(obj_json)\\r\\n    | order by ingest_date asc\",\"size\":0,\"title\":\"Daily Ingestion Detailed Cost (Excludes Retention)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"chartSettings\":{\"xAxis\":\"ingest_date\",\"group\":null,\"createOtherGroup\":0}},\"name\":\"IngestionCostOverTimeGrid\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/60f0fad6-2655-4552-ae41-ba05ebfe561c/resourcegroups/rg-sentinel/providers/microsoft.operationalinsights/workspaces/sentinel-msdemo\"],\"fromTemplateId\":\"sentinel-UserWorkbook\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}